#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "${BLOCK_PATH:-"$shome/work"}/block/script/profile" ~
  source normalize  

  local nm_spec="${1}"; shift
  local hst_remote=

  case "$nm_spec" in
    */*)
      hst_remote="${nm_spec%%/*}"
      nm_session="${nm_spec##*/}"
      ;;
    *.*)
      hst_remote="${nm_spec}"
      nm_session="${hst_remote%%.*}"
      ;;
    *)
      nm_session="$nm_spec"
      ;;
  esac

  set -x

  local hst_loader=
  if [[ -n "$hst_remote" ]]; then
    hst_loader="ssh -tA $hst_remote $@ env TERM_PROGRAM=${TERM_PROGRAM:-} CUE_SCHEME=${CUE_SCHEME:-}"
  fi
  $hst_loader bash -c "env | grep SSH_AUTH; ln -nfs \${SSH_AUTH_SOCK} \$HOME/.ssh/ssh_auth_sock; tmux -CC -L $nm_session attach || tmux -CC -L $nm_session"
}

source sub "$BASH_SOURCE" "$@"
