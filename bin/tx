#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "${BLOCK_PATH:-"$shome/work"}/block/script/profile" ~
  source normalize  

  local hst_remote="${1}"; shift
  
  set -x

  local loader=
  if [[ -n "$hst_remote" ]]; then
    loader="ssh $hst_remote"
  fi

  gpg2 --card-status
  

  local pth_socket="$($loader gpgconf --list-dir | grep agent-socket: | perl -pe 's{agent-socket:}{};s{\s+$}{}')"

  if [[ -n "$pth_socket" ]]; then
    $loader pkill -9 gpg-agent || true &
    $loader rm -fv "${pth_socket}" &
    wait
  fi


  if [[ "$#" == 0 ]]; then
    set -- attach
  fi
  export TX_GPG="$(gpg2 --card-status | awk '/General key info/ {print $NF}' | cut -d'<' -f2 | cut -d'>' -f1)"
  $loader -tA ${pth_socket:+-R "${pth_socket}":/tmp/S.forwarded} bash -c "env | grep SSH_AUTH; ln -nfs \${SSH_AUTH_SOCK} \$HOME/.ssh/ssh_auth_sock; export TERM_PROGRAM=${TERM_PROGRAM:-} CUE_SCHEME=${CUE_SCHEME:-} TX_GPG=${TX_GPG:-}; exec tmux -CC $@" 
}

source sub "$BASH_SOURCE" "$@"
