#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "${BLOCK_PATH:-"$shome/work"}/block/script/profile" ~
  source normalize  

  local hst_remote="${1}"; shift
  local loader="ssh $hst_remote"
  
  $loader tmux detach-client -s 0 || true &

  local fn_remote=".tx-remote"
  rsync -ia "$(which tx-remote)" "$hst_remote:$fn_remote" &

  if [[ "$hst_remote" != "localhost" ]]; then
    export TX_GPG="$(gpg2 --card-status 2>/dev/null | awk '/General key info/ {print $NF}' | cut -d'<' -f2 | cut -d'>' -f1)"
    gpg2 --export -a "$TX_GPG" | $loader gpg2 --import &

    rsync -ia ~/.aws $hst_remote: &
    if [[ -d ~/.awsvault ]]; then
      rsync -ia ~/.awsvault  $hst_remote: &
    fi

    local pth_socket="$($loader gpgconf --list-dir | grep agent-socket: | perl -pe 's{agent-socket:}{};s{\s+$}{}')"
    if [[ -n "$pth_socket" ]]; then
      $loader pkill -9 gpg-agent || true &
      $loader rm -fv "${pth_socket}" &
    fi
  fi

  wait

  $loader -tA ${pth_socket:+-R "${pth_socket}":/tmp/S.forwarded} \
    -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \
        env TERM_PROGRAM=${TERM_PROGRAM:-} CUE_SCHEME=${CUE_SCHEME:-} TX_GPG=${TX_GPG:-} "$fn_remote"
}

source sub "$BASH_SOURCE" "$@"
