#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "${BLOCK_PATH:-"$shome/work"}/block/script/profile" ~
  source normalize  

  set -x
  local hst_remote="${1}"; shift
  local loader="ssh $hst_remote -o ControlPath=$HOME/.ssh/cm-%r-%h-$$ -o ControlMaster=no $*"
  local rsync="ssh -o ControlPath=$HOME/.ssh/cm-%r-%h-$$ -o ControlMaster=no $*"

  ssh $hst_remote -o ControlPath="$HOME/.ssh/cm-%r-%h-$$" -o ControlMaster=yes -o ControlPersist=1m "$@" tmux detach-client -s 0 || true

  local fn_remote=".tx-remote"
  rsync -ia -e "$rsync" "$(which tx-remote)" "[$hst_remote]:$fn_remote"

  export TX_GPG="$(gpg2 --card-status 2>/dev/null | awk '/General key info/ {print $NF}' | cut -d'<' -f2 | cut -d'>' -f1)"

  if [[ "$hst_remote" != "localhost" ]]; then
    local pth_socket="$($loader gpgconf --list-dir | grep agent-socket: | perl -pe 's{agent-socket:}{};s{\s+$}{}')"
    if [[ -n "$pth_socket" ]]; then
      $loader pkill -9 gpg-agent || true
      $loader rm -fv "${pth_socket}"
    fi

    if false; then
      (
        cd "$HOME/tmp"
        rm -rf "${hst_remote}.mnt"
        cf create "${hst_remote}" -r "${TX_GPG}"
        cf mount "${hst_remote}.mnt" "${hst_remote}"
        touch "${hst_remote}/.done"
        cf unmount "${hst_remote}"
      )

      rsync -ia -e "$rsync" "$HOME/tmp/${hst_remote}.mnt/." "[$hst_remote]":tmp/secrets.mnt/.

      $loader cf unmount secrets || true
    fi

    rsync -ia -e "$rsync" ~/.aws "[$hst_remote]":
    if [[ -d ~/.awsvault ]]; then
      rsync -ia -e "$rsync" ~/.awsvault  --exclude '*session*' "[$hst_remote]":
    fi
    if [[ -d ~/.op ]]; then
      (set +f; rsync -ia -e "$rsync"  ~/.op/* "[$hst_remote]":.op/)
    fi
  fi

  $loader -O exit

  figlet -w 200 "$hst_remote"
  ssh $hst_remote -tA ${pth_socket:+-R "${pth_socket}":/tmp/S.forwarded} \
    -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ControlMaster=no -S none \
    "$@" env TERM_PROGRAM=${TERM_PROGRAM:-} CUE_SCHEME=${CUE_SCHEME:-} TX_GPG=${TX_GPG:-} "$fn_remote" attach
}

source sub "$BASH_SOURCE" "$@"
